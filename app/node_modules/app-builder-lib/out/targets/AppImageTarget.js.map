{"version":3,"sources":["../../src/targets/AppImageTarget.ts"],"names":[],"mappings":"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","sourcesContent":["import { Arch, executeAppBuilderAsJson, serializeToYaml } from \"builder-util\"\nimport { outputFile } from \"fs-extra-p\"\nimport { Lazy } from \"lazy-val\"\nimport * as path from \"path\"\nimport { AppImageOptions } from \"..\"\nimport { Target } from \"../core\"\nimport { LinuxPackager } from \"../linuxPackager\"\nimport { getAppUpdatePublishConfiguration } from \"../publish/PublishManager\"\nimport { getNotLocalizedLicenseFile } from \"../util/license\"\nimport { getTemplatePath } from \"../util/pathManager\"\nimport { LinuxTargetHelper } from \"./LinuxTargetHelper\"\nimport { createStageDir } from \"./targetUtil\"\n\n// https://unix.stackexchange.com/questions/375191/append-to-sub-directory-inside-squashfs-file\nexport default class AppImageTarget extends Target {\n  readonly options: AppImageOptions = {...this.packager.platformSpecificBuildOptions, ...(this.packager.config as any)[this.name]}\n  private readonly desktopEntry: Lazy<string>\n\n  constructor(ignored: string, private readonly packager: LinuxPackager, private readonly helper: LinuxTargetHelper, readonly outDir: string) {\n    super(\"appImage\")\n\n    // we add X-AppImage-BuildId to ensure that new desktop file will be installed\n    this.desktopEntry = new Lazy<string>(() => helper.computeDesktopEntry(this.options, \"AppRun\", {\n      \"X-AppImage-Version\": `${packager.appInfo.buildVersion}`,\n    }))\n  }\n\n  async build(appOutDir: string, arch: Arch): Promise<any> {\n    const packager = this.packager\n    const options = this.options\n    // https://github.com/electron-userland/electron-builder/issues/775\n    // https://github.com/electron-userland/electron-builder/issues/1726\n    // tslint:disable-next-line:no-invalid-template-strings\n    const artifactName = packager.expandArtifactNamePattern(options, \"AppImage\", arch, \"${name}-${version}-${arch}.${ext}\", false)\n    const artifactPath = path.join(this.outDir, artifactName)\n    this.logBuilding(\"AppImage\", artifactPath, arch)\n\n    const c = await Promise.all([\n      this.desktopEntry.value,\n      this.helper.icons,\n      getAppUpdatePublishConfiguration(packager, arch, false /* in any case validation will be done on publish */),\n      getNotLocalizedLicenseFile(options.license, this.packager, [\"txt\", \"html\"]),\n      createStageDir(this, packager, arch),\n    ])\n    const license = c[3]\n    const stageDir = c[4]\n\n    const publishConfig = c[2]\n    if (publishConfig != null) {\n      await outputFile(path.join(packager.getResourcesDir(stageDir.dir), \"app-update.yml\"), serializeToYaml(publishConfig))\n    }\n\n    if (this.packager.packagerOptions.effectiveOptionComputed != null && await this.packager.packagerOptions.effectiveOptionComputed({desktop: await this.desktopEntry.value})) {\n      return\n    }\n\n    const args = [\n      \"appimage\",\n      \"--stage\", stageDir.dir,\n      \"--arch\", Arch[arch],\n      \"--output\", artifactPath,\n      \"--app\", appOutDir,\n      \"--template\", path.join(getTemplatePath(\"linux\"), \"AppRun.sh\"),\n      \"--configuration\", (JSON.stringify({\n        productName: this.packager.appInfo.productName,\n        desktopEntry: c[0],\n        executableName: this.packager.executableName,\n        systemIntegration: options.systemIntegration || \"ask\",\n        icons: c[1],\n        fileAssociations: this.packager.fileAssociations,\n      })),\n    ]\n    if (packager.compression === \"maximum\") {\n      args.push(\"--compression\", \"xz\")\n    }\n    if (license != null) {\n      args.push(\"--license\", license)\n    }\n\n    packager.info.dispatchArtifactCreated({\n      file: artifactPath,\n      safeArtifactName: packager.computeSafeArtifactName(artifactName, \"AppImage\", arch, false),\n      target: this,\n      arch,\n      packager,\n      isWriteUpdateInfo: true,\n      updateInfo: await executeAppBuilderAsJson(args),\n    })\n  }\n}\n"],"sourceRoot":""}
